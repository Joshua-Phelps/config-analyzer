[
  {
    "name": "accidental-public-storage",
    "description": "Finds Storage Accounts with a Private Endpoint configured but the public endpoint is still enabled",
    "type": "ResourceGraph",
    "query": "Resources | where type=~ 'Microsoft.Storage/storageAccounts' and isnotempty(properties.privateEndpointConnections[0]) and properties.networkAcls.defaultAction=~ 'Allow'"
  },
  {
    "name": "event-hubs-not-locked-down",
    "description": "Finds Event Hubs with a network rules set having zero IP or virtual network rules for the namespace",
    "type": "ResourceGraph",
    "query": "Resources | where type == 'Microsoft.EventHub/namespaces/networkrulesets'  and (isempty(properties.ipRules[0]) or isempty(properties.virtualNetworkRules[0]))"
  },
  {
    "name": "event-hubs-default-action-deny",
    "description": "Finds Event Hubs with a network rules set having one or more IP or virtual network rules but the default action is not deny",
    "type": "ResourceGraph",
    "query": "Resources | where type == 'Microsoft.EventHub/namespaces/networkrulesets'  and (isnotempty(properties.ipRules[0]) or isnotempty(properties.virtualNetworkRules[0])) and properties.defaultAction !~ 'Allow'"
  },
  {
    "name": "event-hubs-default-action-deny",
    "description": "Finds Event Hubs with a network rules set having one or more IP or virtual network rules but the default action is not deny",
    "type": "ARM",
    "evaluations": [
      {
        "resourceType": "Microsoft.EventHub/namespaces/networkRuleSets",
        "path": [
          "properties",
          "ipRules",
          "length"
        ],
        "evaluate": {
          "operator": "shouldNotEqual",
          "value": "0"
        },
        "or": {
          "resourceType": "Microsoft.EventHub/namespaces/networkRuleSets",
          "path": [
            "properties",
            "virtualNetworkRules",
            "length"
          ],
          "evaluate": {
            "operator": "shouldNotEqual",
            "value": "0"
          }
        }
      }
    ]
  },
  {
    "name": "accidental-public-storage",
    "description": "Finds Storage Accounts with a Private Endpoint configured but the public endpoint is still enabled",
    "type": "ARM",
    "evaluations": [
      {
        "id": 1,
        "resourceType": "Microsoft.Storage/storageAccounts",
        "path": [
          "properties",
          "networkAcls",
          "defaultAction"
        ],
        "evaluate": {
          "operator": "shouldNotEqual",
          "value": "Allow",
          "nextPathRef": "id"
        },
        "and": { 
          "id": 2,
          "resourceType": "Microsoft.Storage/storageAccounts/privateEndpointConnections",
          "path": [
            "dependsOn"
          ],
          "evaluate": {
            "operator": "notIncludes"
          }
        }
      }
    ]
  },
  {
    "name": "Dummy Mock Rule",
    "description": "Mocks a multiple rule system",
    "type": "Dummy",
    "context": {
      "message": "I don't do anything"
    }
  }
]