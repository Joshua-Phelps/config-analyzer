[
  {
    "name": "accidental-public-storage",
    "description": "Finds Storage Accounts with a Private Endpoint configured but the public endpoint is still enabled",
    "type": "ResourceGraph",
    "query": "Resources | where type=~ 'Microsoft.Storage/storageAccounts' and isnotempty(properties.privateEndpointConnections[0]) and properties.networkAcls.defaultAction=~ 'Allow'"
  },
  {
    "name": "event-hubs-default-action-deny",
    "description": "Finds Event Hubs with a network rules set having one or more IP or virtual network rules but the default action is not deny",
    "type": "ARM",
    "evaluation": {
      "resourceType": "Microsoft.EventHub/namespaces/networkRuleSets",
      "path": [
        "properties",
        "ipRules",
        "length"
      ],
      "operator": "!=",
      "value": 0,
      "and": [{
        "resourceType": "Microsoft.EventHub/namespaces/networkRuleSets",
        "path": [
          "properties",
          "virtualNetworkRules",
          "length"
        ],
        "operator": "!=",
        "value": 0
      }]
    }
  },
  {
    "name": "accidental-public-storage",
    "description": "Finds Storage Accounts with a Private Endpoint configured but the public endpoint is still enabled",
    "type": "ARM",
    "evaluation": {
      "resourceType": "Microsoft.Storage/storageAccounts",
      "path": [
        "properties",
        "networkAcls",
        "defaultAction"
      ],
      "operator": "!=",
      "value": "Allow",
      "or": [{
        "resourceType": "Microsoft.Network/privateEndpoints",
        "path": [
          "dependsOn"
        ],
        "operator": "notIn",
        "parentPath": [
          "id"
        ]
      }]
    }
  }
]